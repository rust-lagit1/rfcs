- Feature Name: multifile-changelogs
- Start Date: 2017-08-27
- RFC PR: (leave this empty)
- Rust Issue: (leave this empty)

# Summary
[summary]: #summary

Add multi-file changelog support to `cargo` and [crates.io](https://crates.io/).

# Motivation
[motivation]: #motivation

This proposal was initially part of the another [RFC](https://github.com/rust-lang/rfcs/pull/2129),
but it was decided to split into a separate RFC. Please see its
[motivation](https://github.com/newpavlov/rfcs/blob/master/text/0000-crate-changelogs.md#motivation) section for the context.

Goal of this proposal is to define additional approach to keeping changelogs,
which is more strict compared to one described in the parent RFC and tied more
closely to crates.io.

# Guide-level explanation
[guide-level-explanation]: #guide-level-explanation

Lets imagine you have a crate with three published versions (0.1.0, 0.1.1, 0.2.0)
and some yet unreleased changes. You can use `changelogs` folder in the root of
your crate to specify important changes in each crate version:
```
├── Cargo.toml
├── changelogs
│   ├── header.md
│   ├── unreleased.md
│   ├── 0.1.0.md
│   ├── 0.1.1.md
│   └── 0.2.0.md
└── src
    └── ...
```

All files except `header.md` and `unreleased.md` must be named as `<version>.md`.

`unreleased.md`, `0.1.0.md`, `0.1.1.md` and `0.2.0.md` should contain changes
in the format specified by [keepachangelog.com](http://keepachangelog.com),
i.e. written for humans (no commit history dumps) with changes grouped by
following types:

- `Added` for new features.
- `Changed` for changes in existing functionality.
- `Deprecated` for soon-to-be removed features.
- `Removed` for now removed features.
- `Fixed` for any bug fixes.
- `Security` in case of vulnerabilities.

For example:

```
# Added
- New functions: `foo`, `bar`
- Documentation for `Zoo`

# Fixed
- Bugs: #1, #2, #3
```

Although it's a recommended format, for simple projects you can use a simple
bullet list without splitting it into categories.

`unreleased.md` used for accumulation of features commited to the crate
repository, but not yet published. When publishing new crate version rename it
to the new crate version. If `cargo publish` will detect `changelogs` folder,
but not a changelog file for the new version it will refuse to publish it.
(this behaviour can be disabled by `--allow-no-changelog`) Although it will not
check changelogs for older versions.

`header.md` is optional and can contain header to be included in the full
changelog which can be generated by `cargo changelog` command and which will
be displayed on [crates.io](https://crates.io/). For example it can have the
folowing content:
```
# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/en/1.0.0/)
and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.html).

```

By executing `cargo changelog` you can generate full changelog, by default
it will be saved as `CHANGELOG.md`, which will be formatted in the following
way:
```
# Changelog
All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](http://keepachangelog.com/en/1.0.0/)
and this project adheres to [Semantic Versioning](http://semver.org/spec/v2.0.0.html).

## [Unreleased]
### Added
- Function `bar`

## [0.2.0] - 2017-03-03
### Removed
- Deprecated function `foo`

## [0.1.1] - 2017-02-02
### Deprecated
- Function `foo`

## [0.1.0] - 2017-01-01
### Added
- Functions: `foo`, `bar`
- Documentation for `Zoo`

### Fixed
- Bugs: #1, #2, #3
```

Release dates will be taken from crates.io, additionally `[YANKED]` markers will
be added for yanked crate versions. Headers from changelog files will be
automatically converted to sub-headers. In case if changelog file will be
detected for unpublished version it will cause `cargo publish` and
`cargo changelog` to exit with an error.

In case if both `changelogs` folder and `changelog` field in the `[package]`
section of `Cargo.toml` are present, crates.io will use
changelog specified in the `changelog` field.

# Reference-level explanation
[reference-level-explanation]: #reference-level-explanation

Implementation of described features is fairly straightforward. Although it's
worth to mention several corner cases.

## Generating changelog offline

Without internet connection `cargo changelog` will not be able to fetch
dates and yank status for versions, in such scenario `cargo changelog --offline`
option can be used to generate changelog without them.

## Maintaining older crate versions

Some crates will continue to publish updates for older versions. (e.g.
publishing bug fixes and feature updates for `1.0` branch with master on `2.0`)
For such cases it would be usefull to have a tool which will allow to pull
changelog files from other branches.

One way to do it will be to add `cargo changelog pull` command which will
pull changelog files from crates.io. So for example we have `1.0.0.md`
and `2.0.0.md` on master branch, and we publish version `1.0.1` from branch
which contains `1.0.0.md` and `1.0.1.md`. Now we call `cargo changelog pull` on
master branch, this command will ask `crates.io` for changelog files which it
does not currently have, in our case it will be only `1.0.1.md`.

In case of the conflict changelog files from bigger versions will be taken.
So if we have `1.0.1` and `1.0.2` with different `1.0.1.md` files, version from
`1.0.2` will be taken. Same goes for generation of full changelog on crates.io,
it should not only take latest published crate version, but also look for
missing changelog files in other crate versions if needed.

# Drawbacks
[drawbacks]: #drawbacks

- This proposal fixes MarkDown as markup language for changelogs
- Splitting changelog into several files is unconventional and ties changelog
to crates.io registry

# Rationale and Alternatives
[alternatives]: #alternatives

Proposed way of handling changelogs reduces amount of manual work needed for
maintaining changelog and encourages crate authors to keep changelogs for all
versions through checks in `cargo publish`. Additionally it ensures full
synchronisation between crates.io registry and generated changelogs.

Alternative would be to do nothing and rely only on `changelog` field in
`Cargo.toml`.

# Unresolved questions
[unresolved]: #unresolved-questions

- Should we recommend to rgenerate `CHANGELOG.md` every time or link to crates.io
section instead?
- Support for non-english changelogs. What to do with [Unreleased] and
[YANKED]?
- Should we completely omit versions without changelog files in the full
changelog or should we add line with version and publishing date?
- How to handle pre-release versions? (e.g. `1.0.0-rc1`)
